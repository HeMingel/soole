<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.songpo.searched.mapper.CmOrderMapper">

    <select id="findList" parameterType="String" resultType="java.util.Map">
        select
        ss.name shopName,
        spr.product_name productName,
        spr.product_detail_group_name groupName,
        spr.product_image_url goodimageUrl,
        sod.quantity counts,
        so.payment_state paymentState,
        so.shipping_state shippingState,
        sod.price price,
        sod.deduct_total_silver pulse,
        sod.post_fee postFee,
        ss.image_url shopImageUrl,
        sp.sales_mode_id salesModeId,
        so.id orderId,
        spr.ship ship,
        so.type type,
        so.serial_number serialNumber,
        sod.buyer_message buyerMessage,
        ss.phone shopPhone
        from sl_order_detail sod
        LEFT JOIN sl_order so ON so.id = sod.order_id
        LEFT JOIN sl_product sp ON sod.product_id = sp.id
        LEFT JOIN sl_shop ss ON sod.shop_id = ss.id
        LEFT JOIN sl_product_repository spr ON sod.repository_id = spr.id
        LEFT JOIN sl_sales_mode ssm ON ssm.id = spr.sales_mode_id
        WHERE sod.creator = #{userId} and so.status = 1 AND so.user_id = #{userId}
        ORDER BY so.create_time DESC
    </select>

    <select id="findUserAvatar" resultType="java.lang.String">
        select
        su.avatar avatar
        from sl_user su
        LEFT JOIN sl_order so ON su.id = so.user_id
        WHERE so.payment_state = '1' AND so.serial_number = #{serialNumber}
        limit 10
    </select>

    <select id="selectMyOrderInfo" resultType="java.util.Map">
        select
        so.consigneeName consigneeName,
        so.consigneePhone consigneePhone,
        so.province province,
        so.city city,
        so.county county,
        so.detailed detailed,
        so.create_time createTime,
        so.total_amount totalAmount
        so.deduct_total_pulse totalPulse,
        so.serial_number orderNum,
        so.type AS type
        from sl_order so
        WHERE so.user_id = #{userId} and so.id = #{orderId}
    </select>

    <select id="findGroup" resultType="java.util.Map">
       SELECT
          sod.serial_number serialNumber
         (SELECT
            COUNT(1)
          FROM
            sl_order_detail sod
            LEFT JOIN sl_order so
              ON so.id = sod.order_id
            LEFT JOIN sl_activity_product sap
              ON sap.product_id = sod.product_id
          WHERE sod.create_time BETWEEN sap.begin_time
            AND sap.end_time
            AND sap.activity_id = '7812dbd4-9063-4991-8551-f3fedce8cf9a'
            AND so.type = 2
            AND sod.product_id = #{productId}
             AND so.payment_state = 0
            OR so.payment_state = 1) orderCounts
        FROM
          sl_order_detail sod
          LEFT JOIN sl_order so ON so.id = sod.order_id
          LEFT JOIN sl_activity_product AS sap ON sap.product_id = sod.product_id
        WHERE sod.create_time BETWEEN sap.begin_time
          AND sap.end_time
          AND sap.activity_id = '7812dbd4-9063-4991-8551-f3fedce8cf9a'
          AND so.type = 2
          AND sod.product_id = #{productId}
          AND so.payment_state = 0 OR so.payment_state = 1
        ORDER BY sod.create_time DESC
        LIMIT 1
    </select>

    <select id="findActivityProduct" resultType="java.util.Map">
        select
        sap.count counts,
        sap.people_num peopleNum,
        sap.id activityProductId,
        sap.begin_time beginTime,
        sap.end_time endTime,
        sap.orders_num ordersNum,
        sap.surplus_product_count surplusProductCount
        from sl_activity_product sap
        LEFT JOIN sl_activity sa ON sap.activity_id = sa.id
        WHERE
        sap.product_id = #{productId}
        and
        now() &lt; sap.end_time
        order by sap.begin_time DESC
        limit 1
    </select>

</mapper>